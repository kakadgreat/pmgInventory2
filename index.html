<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Inventory Home</title>
<link rel="stylesheet" href="style.css"/>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<header id="topbar" class="topbar">
  <div class="topbar-inner">
    <a class="btn" href="index.html">Home</a>
    <a class="btn" href="list.html">List</a>
    <a class="btn" href="table.html">Table</a>
    <a class="btn" href="locations.html">Locations</a>
    <a class="btn" href="data.json">Data (JSON)</a>
    <a class="btn" href="README.html">README</a>
    <a class="btn" href="phone.html">Phone Directory</a>
  </div>
</header>

<main class="container">
  <!-- Quick actions -->
  <section class="pill">
    <h2>Quick actions</h2>
    <p class="small">Add or manage items right from here.</p>
    <div class="row" style="gap:.5rem; flex-wrap:wrap">
      <a class="btn primary" href="admin/add">Add Item</a>
      <a class="btn" href="admin/">Admin</a>
      <a class="btn" href="/.netlify/functions/config">Config</a>
      <a class="btn" href="phone.html">Phone Directory</a>
    </div>
  </section>

  <!-- Inventory Overview: pills left, mini charts right -->
  <section class="pill">
    <h2>Inventory Overview</h2>
    <p class="small">Data parsed from <em>Computer Inventory 2025 Ankur.xlsx</em>. Click a category to view details.</p>

    <div class="overview-grid">
      <div id="catPills" class="chips"></div>

      <aside class="overview-side">
        <div class="mini-chart">
          <h3>By Category</h3>
          <!-- explicit height prevents growth -->
          <canvas id="catChart" height="160"></canvas>
        </div>
        <div class="mini-chart">
          <h3>Warranty</h3>
          <canvas id="warChart" height="160"></canvas>
        </div>
      </aside>
    </div>
  </section>
</main>

<script>
const PALETTE=["#10b981","#60a5fa","#f59e0b","#ef4444","#a78bfa","#34d399","#f472b6","#f97316","#22d3ee","#84cc16"];

async function load(){ try{ const r=await fetch('/.netlify/functions/inventory',{cache:'no-store'}); if(r.ok) return await r.json(); }catch(e){} return []; }
async function cfg(){ try{ const r=await fetch('/.netlify/functions/config'); if(r.ok) return await r.json(); }catch(e){} return { categories:["Desktops","Laptops","Phones","Other"] }; }

function by(list, key){
  const m=new Map();
  list.forEach(x=>{
    const k = (typeof key==='function')? key(x) : (x[key]||'Unknown');
    m.set(k,(m.get(k)||0)+1);
  });
  return m;
}
function pill(label, n){ return `<a class="chip" href="list.html?category=${encodeURIComponent(label)}">${label} (${n})</a>`; }
function makePie(ctx, labels, values){
  const colors=labels.map((_,i)=>PALETTE[i%PALETTE.length]);
  return new Chart(ctx,{
    type:'pie',
    data:{ labels, datasets:[{ data:values, backgroundColor:colors, borderColor:'#fff', borderWidth:2 }]},
    options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ display:false } } }
  });
}
function normWarranty(s){ s=String(s||'').trim().toLowerCase(); if(s==='active'||s==='deactivated') return s[0].toUpperCase()+s.slice(1); return 'Unknown'; }

(async () => {
  const [data, conf] = await Promise.all([load(), cfg()]);

  // category pills
  const catCounts = by(data,'category');
  const order = (conf.categories?.length ? conf.categories : Array.from(catCounts.keys()));
  document.getElementById('catPills').innerHTML = order
    .filter(Boolean)
    .map(k => pill(k, catCounts.get(k)||0))
    .join('');

  // mini pies
  const catLabels = order.filter(Boolean);
  const catValues = catLabels.map(k=>catCounts.get(k)||0);
  makePie(document.getElementById('catChart').getContext('2d'), catLabels, catValues);

  const wCounts = by(data, x => normWarranty(x.warranty_status));
  const wLabels = ['Active','Deactivated','Unknown'].filter(k=>wCounts.has(k));
  const wValues = wLabels.map(k=>wCounts.get(k)||0);
  makePie(document.getElementById('warChart').getContext('2d'), wLabels, wValues);
})();
</script>
</body>
</html>
