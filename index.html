<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Inventory Home</title>
<link rel="stylesheet" href="style.css"/>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>
<body>
<header id="topbar" class="topbar">
  <div class="topbar-inner">
    <a class="btn" href="index.html">Home</a>
    <a class="btn" href="list.html">List</a>
    <a class="btn" href="table.html">Table</a>
    <a class="btn" href="locations.html">Locations</a>
    <a class="btn" href="data.json">Data (JSON)</a>
    <a class="btn" href="README.html">README</a>
    <a class="btn" href="phone.html">Phone Directory</a>
  </div>
</header>

<main class="container">
  <!-- System/health -->
  <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:.5rem">
    <div class="small">Welcome! Use Quick actions below or jump to a saved View.</div>
    <span id="health" class="badge">Loading…</span>
  </div>

  <!-- Quick actions -->
  <section class="pill">
    <h2>Quick actions</h2>
    <div class="row" style="gap:.5rem;flex-wrap:wrap">
      <a class="btn primary" href="admin/add">Add Item</a>
      <a class="btn" href="admin/add?category=Desktops">Add Desktop</a>
      <a class="btn" href="admin/add?category=Laptops">Add Laptop</a>
      <a class="btn" href="admin/">Admin</a>
      <a class="btn" href="/.netlify/functions/config">Config</a>
      <span class="row" style="gap:.4rem;margin-left:auto">
        <input id="phoneQ" placeholder="Find a person/ext…" />
        <a class="btn" id="phoneGo">Phone search</a>
      </span>
    </div>
  </section>

  <!-- Stat cards -->
  <section class="pill">
    <div class="stat-grid" id="stats"></div>
  </section>

  <!-- Inventory overview with mini pies -->
  <section class="pill">
    <h2>Inventory Overview</h2>
    <p class="small">Data parsed from <em>Computer Inventory 2025 Ankur.xlsx</em>. Click a category to view details.</p>
    <div class="overview-grid">
      <div id="catPills" class="chips"></div>
      <aside class="overview-side">
        <div class="mini-chart"><h3>By Category</h3><canvas id="catChart" height="160"></canvas></div>
        <div class="mini-chart"><h3>Warranty</h3><canvas id="warChart" height="160"></canvas></div>
      </aside>
    </div>
  </section>

  <!-- Expiring soon -->
  <section class="pill">
    <div class="row" style="justify-content:space-between;align-items:center">
      <h2 style="margin:0">Expiring Soon</h2>
      <div class="row" style="gap:.4rem">
        <label class="small">Window</label>
        <select id="expWin">
          <option value="30">30 days</option>
          <option value="60" selected>60 days</option>
          <option value="90">90 days</option>
        </select>
      </div>
    </div>
    <table class="exp-table" id="expTbl">
      <thead><tr><th>Title</th><th>Category</th><th>Location</th><th>Warranty Expires</th><th></th></tr></thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- Location heatmap -->
  <section class="pill">
    <h2>Location Heatmap</h2>
    <div class="chart-card">
      <canvas id="locChart" height="220"></canvas>
    </div>
  </section>

  <!-- Views + tools -->
  <section class="pill">
    <div class="row" style="justify-content:space-between;align-items:center">
      <h2 style="margin:0">Saved Views & Tools</h2>
      <div class="row no-print" style="gap:.5rem">
        <button class="btn blue" id="btnCSV">Export CSV</button>
        <button class="btn blue" id="btnQR">QR Labels</button>
      </div>
    </div>

    <div class="row no-print" style="gap:.5rem;flex-wrap:wrap;margin:.5rem 0">
      <input id="viewName" placeholder="View name (e.g., Rome Laptops)"/>
      <select id="viewLoc" title="Location"></select>
      <select id="viewCats" multiple title="Categories" style="min-width:220px"></select>
      <button class="btn" id="saveView">Save view</button>
    </div>
    <div id="views" class="chips"></div>
  </section>
</main>

<!-- QR overlay -->
<div id="qrOverlay" class="qr-overlay no-print" style="display:none">
  <div class="qr-controls">
    <button class="btn" id="qrClose">Close</button>
    <button class="btn blue" onclick="window.print()">Print</button>
  </div>
  <div id="qrGrid" class="qr-grid"></div>
</div>

<script>
/* ---------- utilities & robust data load ---------- */
const PALETTE=["#10b981","#60a5fa","#f59e0b","#ef4444","#a78bfa","#34d399","#f472b6","#f97316","#22d3ee","#84cc16"];
const FALLBACK_LOC=["Jasper Primary Care","Jasper Pediatrics","Jasper MedSpa","Roswell Primary Care","Roswell MedSpa","Canton Primary Care","Canton Pediatrics","Canton MedSpa","Rome Primary Care","Rome MedSpa"];
async function getJSON(u){const r=await fetch(u,{cache:'no-store'});if(!r.ok)throw new Error(r.status);return r.json();}
async function loadData(){
  try{const d=await getJSON('/.netlify/functions/inventory'); return {items:Array.isArray(d)?d:(d.items||[]),source:'fn'};}
  catch(e){try{const d=await getJSON('/data.json');return{items:Array.isArray(d)?d:(d.items||[]),source:'fallback'};}
  catch(e2){return{items:[],source:'error'};}}
}
async function loadCfg(){try{return await getJSON('/.netlify/functions/config');}catch{return{locations:FALLBACK_LOC,categories:["Desktops","Laptops","Phones","Other"]};}}
function by(list, key){const m=new Map();list.forEach(x=>{const k=(typeof key==='function')?key(x):(x[key]||'Unknown');m.set(k,(m.get(k)||0)+1)});return m;}
function toCSV(rows){
  if(!rows.length) return '';
  const keys=[...new Set(rows.flatMap(r=>Object.keys(r)))];
  const esc=v=>`"${String(v??'').replaceAll('"','""')}"`;
  return [keys.join(','),...rows.map(r=>keys.map(k=>esc(r[k])).join(','))].join('\n');
}
function parseDate(s){ if(!s) return null; const d=new Date(s); return isNaN(d)?null:d; }
function daysUntil(d){ const ms=d - new Date(); return Math.ceil(ms/86400000);}

/* ---------- small helpers ---------- */
function pie(ctx,labels,data){const colors=labels.map((_,i)=>PALETTE[i%PALETTE.length]);return new Chart(ctx,{type:'pie',data:{labels,datasets:[{data,backgroundColor:colors,borderColor:'#fff',borderWidth:2}]},options:{plugins:{legend:{display:false}},maintainAspectRatio:false,responsive:true}});}
function bar(ctx,labels,data){return new Chart(ctx,{type:'bar',data:{labels,datasets:[{data,backgroundColor:'#60a5fa'}]},options:{plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}});}

/* ---------- main ---------- */
(async ()=>{
  const [{items,source}, cfg] = await Promise.all([loadData(), loadCfg()]);
  const health=document.getElementById('health');
  if(source==='fn'){ health.textContent='Live data'; health.className='badge fn-ok'; }
  else if(source==='fallback'){ health.textContent='Using data.json'; health.className='badge fn-fallback'; }
  else { health.textContent='Data error'; health.className='badge fn-error'; }

  const data = items;
  const cats = cfg.categories?.length?cfg.categories:[...new Set(data.map(x=>x.category).filter(Boolean))];
  const locs = cfg.locations?.length?cfg.locations:FALLBACK_LOC;

  /* Quick phone search */
  document.getElementById('phoneGo').onclick = () => {
    const q=document.getElementById('phoneQ').value.trim();
    location.href = 'phone.html?q='+encodeURIComponent(q);
  };

  /* ----- Stat cards ----- */
  function renderStats(){
    const g=document.getElementById('stats'); g.innerHTML='';
    const byCat=by(data,'category'); const active=by(data,x=>(String(x.warranty_status||'').toLowerCase()==='active'?'Active':'Other'));
    const soon=data.filter(x=>{const d=parseDate(x.warranty_expires); return d && daysUntil(d)<=90;}).length;
    const total=data.length, act=(active.get('Active')||0), deact=total-act;

    const make=(title,val,sub='')=>`<div class="stat"><h4>${title}</h4><div class="big">${val}</div><div class="small">${sub}</div></div>`;
    g.insertAdjacentHTML('beforeend', make('Total Items', total, `${cats.map(c=>`${c}: ${byCat.get(c)||0}`).join(' · ')}`));
    g.insertAdjacentHTML('beforeend', make('Active', act, `Deactivated: ${deact}`));
    g.insertAdjacentHTML('beforeend', make('Expiring ≤ 90 days', soon, 'See list below'));
    const phoneCount = (byCat.get('Phones')||byCat.get('Phone')||0);
    g.insertAdjacentHTML('beforeend', make('Phones', phoneCount, 'Quick search above'));
  }
  renderStats();

  /* ----- Overview pills + pies ----- */
  const catCounts = by(data,'category');
  const catPills=document.getElementById('catPills');
  catPills.innerHTML = cats.map(k=>`<a class="chip" href="list.html?categories=${encodeURIComponent(k)}">${k} (${catCounts.get(k)||0})</a>`).join('');
  pie(document.getElementById('catChart').getContext('2d'), cats, cats.map(c=>catCounts.get(c)||0));

  const wCounts = by(data, x => {const s=String(x.warranty_status||'').toLowerCase();return (s==='active'?'Active':(s==='deactivated'?'Deactivated':'Unknown'));});
  const wLabels=['Active','Deactivated','Unknown'].filter(k=>wCounts.has(k));
  pie(document.getElementById('warChart').getContext('2d'), wLabels, wLabels.map(k=>wCounts.get(k)||0));

  /* ----- Expiring soon ----- */
  const expTbl=document.querySelector('#expTbl tbody');
  function drawExp(days=60){
    const list=data.filter(x=>{const d=parseDate(x.warranty_expires); return d && daysUntil(d)<=days;})
                   .sort((a,b)=>parseDate(a.warranty_expires)-parseDate(b.warranty_expires))
                   .slice(0,25);
    expTbl.innerHTML = list.map(x=>`
      <tr>
        <td>${x.title||'-'}</td>
        <td>${x.category||'-'}</td>
        <td>${x.location||'-'}</td>
        <td>${x.warranty_expires||'-'}</td>
        <td><a class="btn sm" href="admin/edit.html?slug=${encodeURIComponent(x.slug||'')}">Edit</a></td>
      </tr>
    `).join('') || `<tr><td colspan="5" class="small">Nothing expiring in this window.</td></tr>`;
  }
  drawExp(60);
  document.getElementById('expWin').onchange=e=>drawExp(parseInt(e.target.value,10));

  /* ----- Location heatmap ----- */
  const byLoc=by(data,'location'); const locLabels=locs.filter(Boolean);
  const locValues=locLabels.map(l=>byLoc.get(l)||0);
  const lc=bar(document.getElementById('locChart').getContext('2d'), locLabels, locValues);
  // click => go to list filtered by location
  document.getElementById('locChart').onclick = (evt)=>{
    const p=lc.getElementsAtEventForMode(evt,'nearest',{intersect:true},true)[0]; if(!p) return;
    const label=lc.data.labels[p.index];
    location.href='list.html?location='+encodeURIComponent(label);
  };

  /* ----- Saved views ----- */
  const viewLoc=document.getElementById('viewLoc'), viewCats=document.getElementById('viewCats'), viewsHost=document.getElementById('views');
  locs.forEach(l=>viewLoc.insertAdjacentHTML('beforeend', `<option>${l}</option>`));
  cats.forEach(c=>viewCats.insertAdjacentHTML('beforeend', `<option>${c}</option>`));
  const loadViews=()=>JSON.parse(localStorage.getItem('pmg_views')||'[]');
  const saveViews=v=>localStorage.setItem('pmg_views',JSON.stringify(v));
  function renderViews(){
    const vs=loadViews();
    viewsHost.innerHTML = vs.map(v=>{
      const qs=[]; if(v.location) qs.push('location='+encodeURIComponent(v.location));
      if(v.categories?.length) qs.push('categories='+encodeURIComponent(v.categories.join('|')));
      return `<a class="view-chip" href="list.html?${qs.join('&')}">${v.name}</a>`;
    }).join('') || `<span class="small">No saved views yet.</span>`;
  }
  renderViews();
  document.getElementById('saveView').onclick = ()=>{
    const name=document.getElementById('viewName').value.trim(); if(!name) return alert('Give the view a name.');
    const loc=viewLoc.value||'';
    const catsSel=[...viewCats.selectedOptions].map(o=>o.value);
    const vs=loadViews(); vs.push({name,location:loc,categories:catsSel}); saveViews(vs); renderViews();
    document.getElementById('viewName').value='';
  };

  /* ----- Export CSV (all items) ----- */
  document.getElementById('btnCSV').onclick = ()=>{
    const csv=toCSV(data); const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='inventory-export.csv'; a.click(); URL.revokeObjectURL(a.href);
  };

  /* ----- QR labels (all items; first 48) ----- */
  const qrOverlay=document.getElementById('qrOverlay'), qrGrid=document.getElementById('qrGrid');
  document.getElementById('btnQR').onclick=()=>{
    qrGrid.innerHTML='';
    data.slice(0,48).forEach(item=>{
      const id='qr-'+(item.slug||crypto.randomUUID());
      const link=location.origin+'/admin/edit.html?slug='+(encodeURIComponent(item.slug||''));
      qrGrid.insertAdjacentHTML('beforeend', `<div class="qr-label"><div id="${id}"></div><div class="meta">${item.title||'-'}<br><span>${item.serial||''}</span></div></div>`);
      new QRCode(document.getElementById(id),{text:link,width:140,height:140,correctLevel:QRCode.CorrectLevel.M});
    });
    qrOverlay.style.display='block';
  };
  document.getElementById('qrClose').onclick=()=>{qrOverlay.style.display='none';};
})();
</script>
</body>
</html>
