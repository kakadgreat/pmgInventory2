<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Inventory Home</title>
<link rel="stylesheet" href="style.css"/>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<style>
  /* little progress bar inside the Active card */
  .bar{height:8px;border-radius:999px;background:#e5e7eb;overflow:hidden}
  .bar > i{display:block;height:100%;background:#10b981}
</style>
</head>
<body>
<header id="topbar" class="topbar">
  <div class="topbar-inner">
    <a class="btn" href="index.html">Home</a>
    <a class="btn" href="list.html">List</a>
    <a class="btn" href="table.html">Table</a>
    <a class="btn" href="locations.html">Locations</a>
    <a class="btn" href="data.json">Data (JSON)</a>
    <a class="btn" href="README.html">README</a>
    <a class="btn" href="phone.html">Phone Directory</a>
  </div>
</header>

<main class="container">
  <!-- Health -->
  <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:.5rem">
    <h1 style="font-size:1.25rem;margin:0">Dashboard</h1>
    <span id="health" class="badge">Loading…</span>
  </div>

  <!-- Quick actions -->
  <section class="pill">
    <h2>Quick actions</h2>
    <div class="row" style="gap:.5rem;flex-wrap:wrap">
      <a class="btn primary" href="admin/add">Add Item</a>
      <a class="btn" href="admin/add?category=Desktops">Add Desktop</a>
      <a class="btn" href="admin/add?category=Laptops">Add Laptop</a>
      <a class="btn" href="admin/">Admin</a>
      <a class="btn" href="/.netlify/functions/config">Config</a>
      <span class="row" style="gap:.4rem;margin-left:auto">
        <input id="phoneQ" placeholder="Find person / ext / team…" />
        <a class="btn" id="phoneGo">Phone search</a>
      </span>
    </div>
  </section>

  <!-- Stat cards -->
  <section class="pill">
    <div class="stat-grid" id="stats"></div>
  </section>

  <!-- Inventory overview + pies -->
  <section class="pill">
    <h2>Inventory Overview</h2>
    <p class="small">Source: <em>Computer Inventory 2025 Ankur.xlsx</em>. Click a category to view details.</p>
    <div class="overview-grid">
      <div id="catPills" class="chips"></div>
      <aside class="overview-side">
        <div class="mini-chart"><h3>By Category</h3><canvas id="catChart" height="160"></canvas></div>
        <div class="mini-chart"><h3>Warranty</h3><canvas id="warChart" height="160"></canvas></div>
      </aside>
    </div>
  </section>

  <!-- Expiring soon -->
  <section class="pill">
    <div class="row" style="justify-content:space-between;align-items:center">
      <h2 style="margin:0">Warranties expiring</h2>
      <div class="row" style="gap:.4rem">
        <label class="small">Window</label>
        <select id="expWin">
          <option value="30">30 days</option>
          <option value="60" selected>60 days</option>
          <option value="90">90 days</option>
        </select>
      </div>
    </div>
    <table class="exp-table" id="expTbl">
      <thead><tr><th>Title</th><th>Category</th><th>Location</th><th>Warranty Expires</th><th></th></tr></thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- Location heatmap -->
  <section class="pill">
    <h2>Location Heatmap</h2>
    <div class="chart-card"><canvas id="locChart" height="220"></canvas></div>
  </section>
</main>

<script>
const FALLBACK_LOC=["Jasper Primary Care","Jasper Pediatrics","Jasper MedSpa","Roswell Primary Care","Roswell MedSpa","Canton Primary Care","Canton Pediatrics","Canton MedSpa","Rome Primary Care","Rome MedSpa"];
const PALETTE=["#10b981","#60a5fa","#f59e0b","#ef4444","#a78bfa","#34d399","#f472b6","#f97316","#22d3ee","#84cc16"];
async function getJSON(u){const r=await fetch(u,{cache:'no-store'}); if(!r.ok)throw new Error(r.status); return r.json();}
async function loadData(){
  try{ const d=await getJSON('/.netlify/functions/inventory'); return {items:Array.isArray(d)?d:(d.items||[]),source:'fn'}; }
  catch{ try{ const d=await getJSON('/data.json'); return {items:Array.isArray(d)?d:(d.items||[]),source:'json'}; } catch{ return {items:[],source:'error'}; } }
}
async function loadCfg(){try{return await getJSON('/.netlify/functions/config');}catch{return{locations:FALLBACK_LOC,categories:["Desktops","Laptops","Phones","Other"]};}}
function by(list,key){const m=new Map(); list.forEach(x=>{const k=(typeof key==='function')?key(x):(x[key]||'Unknown'); m.set(k,(m.get(k)||0)+1)}); return m;}
function parseDate(s){ if(!s) return null; const d=new Date(s); return isNaN(d)?null:d; }
function daysUntil(d){ return Math.ceil((d - new Date())/86400000); }
function pie(ctx,labels,data){const colors=labels.map((_,i)=>PALETTE[i%PALETTE.length]); return new Chart(ctx,{type:'pie',data:{labels,datasets:[{data,backgroundColor:colors,borderColor:'#fff',borderWidth:2}]},options:{plugins:{legend:{display:false}},maintainAspectRatio:false,responsive:true}});}
function bar(ctx,labels,data){return new Chart(ctx,{type:'bar',data:{labels,datasets:[{data,backgroundColor:'#60a5fa'}]},options:{plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}});}

(async ()=>{
  const [{items,source}, cfg] = await Promise.all([loadData(), loadCfg()]);
  const health=document.getElementById('health');
  health.textContent = source==='fn' ? 'Live data' : source==='json' ? 'Using data.json' : 'Data error';
  health.className = source==='fn' ? 'badge fn-ok' : source==='json' ? 'badge fn-fallback' : 'badge fn-error';

  const data=items;
  const cats = cfg.categories?.length?cfg.categories:[...new Set(data.map(x=>x.category).filter(Boolean))];
  const locs = cfg.locations?.length?cfg.locations:FALLBACK_LOC;

  // PHONE QUICK SEARCH
  document.getElementById('phoneGo').onclick = () => {
    const q=document.getElementById('phoneQ').value.trim();
    location.href = 'phone.html?q='+encodeURIComponent(q);
  };

  // ====== STAT CARDS ======
  const s = document.getElementById('stats');
  const byCat = by(data,'category');
  const total = data.length;
  const active = data.filter(x => String(x.warranty_status||'').toLowerCase()==='active').length;
  const deact  = total - active;
  const pct = total ? Math.round(active*100/total) : 0;

  const exp90 = data.filter(x => {const d=parseDate(x.warranty_expires); return d && daysUntil(d)<=90;});
  const exp30 = exp90.filter(x => daysUntil(parseDate(x.warranty_expires))<=30).length;
  const exp60 = exp90.filter(x => daysUntil(parseDate(x.warranty_expires))>30 && daysUntil(parseDate(x.warranty_expires))<=60).length;
  const exp90only = exp90.length - exp30 - exp60;

  const make = (title,html,sub='')=>`<div class="stat"><h4>${title}</h4><div class="big">${html}</div><div class="small">${sub}</div></div>`;
  s.innerHTML =
    make('Total inventory', total, cats.map(c=>`${c}: ${byCat.get(c)||0}`).join(' · ')) +
    make('Active status', `${active} / ${total}<div class="bar" style="margin-top:.35rem"><i style="width:${pct}%"></i></div>`, `Deactivated: ${deact}`) +
    make('Expiring soon', exp90.length, `30d: ${exp30} · 60d: ${exp60} · 90d: ${exp90only}`) +
    make('Phones', byCat.get('Phones')||byCat.get('Phone')||0, 'Use quick search above');

  // ====== OVERVIEW PILLS + PIES ======
  const catPills=document.getElementById('catPills');
  const pills = cats.map(c=>({c,n:byCat.get(c)||0})).filter(x=>x.n>0).sort((a,b)=>b.n-a.n);
  catPills.innerHTML = pills.map(x=>`<a class="chip" href="list.html?categories=${encodeURIComponent(x.c)}">${x.c} (${x.n})</a>`).join('');
  pie(document.getElementById('catChart').getContext('2d'), pills.map(x=>x.c), pills.map(x=>x.n));

  const wCounts = by(data, x => {
    const s=String(x.warranty_status||'').toLowerCase();
    return s==='active'?'Active':s==='deactivated'?'Deactivated':'Unknown';
  });
  const wLabels=['Active','Deactivated','Unknown'].filter(k=>wCounts.has(k));
  pie(document.getElementById('warChart').getContext('2d'), wLabels, wLabels.map(k=>wCounts.get(k)||0));

  // ====== EXPIRING LIST ======
  const expTbl=document.querySelector('#expTbl tbody');
  function drawExp(win=60){
    const list=data
      .filter(x=>{const d=parseDate(x.warranty_expires); return d && daysUntil(d)<=win;})
      .sort((a,b)=>parseDate(a.warranty_expires)-parseDate(b.warranty_expires))
      .slice(0,25);
    expTbl.innerHTML = list.map(x=>`
      <tr>
        <td>${x.title||'-'}</td>
        <td>${x.category||'-'}</td>
        <td><a href="list.html?location=${encodeURIComponent(x.location||'')}">${x.location||'-'}</a></td>
        <td>${x.warranty_expires||'-'}</td>
        <td><a class="btn sm" href="admin/edit.html?slug=${encodeURIComponent(x.slug||'')}">Edit</a></td>
      </tr>
    `).join('') || `<tr><td colspan="5" class="small">Nothing expiring in this window.</td></tr>`;
  }
  drawExp(60);
  document.getElementById('expWin').onchange=e=>drawExp(parseInt(e.target.value,10));

  // ====== LOCATION HEATMAP ======
  const byLoc = by(data,'location');
  const labels = (locs||[]).filter(Boolean);
  const vals    = labels.map(l=>byLoc.get(l)||0);
  const barChart = new Chart(document.getElementById('locChart').getContext('2d'),{
    type:'bar',
    data:{labels,datasets:[{data:vals,backgroundColor:'#60a5fa'}]},
    options:{plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}
  });
  document.getElementById('locChart').onclick = (evt)=>{
    const p=barChart.getElementsAtEventForMode(evt,'nearest',{intersect:true},true)[0]; if(!p) return;
    const loc = barChart.data.labels[p.index];
    location.href = 'list.html?location='+encodeURIComponent(loc);
  };
})();
</script>
</body>
</html>
