<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Inventory Home</title>
<link rel="stylesheet" href="style.css"/>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>
<body>
<header id="topbar" class="topbar">
  <div class="topbar-inner">
    <a class="btn" href="index.html">Home</a>
    <a class="btn" href="list.html">List</a>
    <a class="btn" href="table.html">Table</a>
    <a class="btn" href="locations.html">Locations</a>
    <a class="btn" href="data.json">Data (JSON)</a>
    <a class="btn" href="README.html">README</a>
    <a class="btn" href="phone.html">Phone Directory</a>
  </div>
</header>

<main class="container">
  <!-- System/health -->
  <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:.5rem">
    <div class="small">Welcome! Use Quick actions below or jump to a saved View.</div>
    <span id="health" class="badge">Loading…</span>
  </div>

  <!-- Quick actions -->
  <section class="pill">
    <h2>Quick actions</h2>
    <div class="row" style="gap:.5rem;flex-wrap:wrap">
      <a class="btn primary" href="admin/add">Add Item</a>
      <a class="btn" href="admin/add?category=Desktops">Add Desktop</a>
      <a class="btn" href="admin/add?category=Laptops">Add Laptop</a>
      <a class="btn" href="admin/">Admin</a>
      <a class="btn" href="/.netlify/functions/config">Config</a>
      <span class="row" style="gap:.4rem;margin-left:auto">
        <input id="phoneQ" placeholder="Find a person/ext…" />
        <a class="btn" id="phoneGo">Phone search</a>
      </span>
    </div>
  </section>

  <!-- Stat cards -->
  <section class="pill">
    <div class="stat-grid" id="stats"></div>
  </section>

  <!-- Inventory overview with mini pies -->
  <section class="pill">
    <h2>Inventory Overview</h2>
    <p class="small">Data parsed from <em>Computer Inventory 2025 Ankur.xlsx</em>. Click a category to view details.</p>
    <div class="overview-grid">
      <div id="catPills" class="chips"></div>
      <aside class="overview-side">
        <div class="mini-chart"><h3>By Category</h3><canvas id="catChart" height="160"></canvas></div>
        <div class="mini-chart"><h3>Warranty</h3><canvas id="warChart" height="160"></canvas></div>
      </aside>
    </div>
  </section>

  <!-- Expiring soon -->
  <section class="pill">
    <div class="row" style="justify-content:space-between;align-items:center">
      <h2 style="margin:0">Expiring Soon</h2>
      <div class="row" style="gap:.4rem">
        <label class="small">Window</label>
        <select id="expWin">
          <option value="30">30 days</option>
          <option value="60" selected>60 days</option>
          <option value="90">90 days</option>
        </select>
      </div>
    </div>
    <table class="exp-table" id="expTbl">
      <thead><tr><th>Title</th><th>Category</th><th>Location</th><th>Warranty Expires</th><th></th></tr></thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- Location heatmap -->
  <section class="pill">
    <h2>Location Heatmap</h2>
    <div class="chart-card">
      <canvas id="locChart" height="220"></canvas>
    </div>
  </section>

  <!-- Views + tools -->
  <section class="pill">
    <div class="row" style="justify-content:space-between;align-items:center">
      <h2 style="margin:0">Saved Views & Tools</h2>
      <div class="row no-print" style="gap:.5rem">
        <button class="btn blue" id="btnCSV">Export CSV</button>
        <button class="btn blue" id="btnQR">QR Labels</button>
      </div>
    </div>

    <div class="row no-print" style="gap:.5rem;flex-wrap:wrap;margin:.5rem 0">
      <input id="viewName" placeholder="View name (e.g., Rome Laptops)"/>
      <select id="viewLoc" title="Location"></select>
      <select id="viewCats" multiple title="Categories" style="min-width:220px"></select>
      <button class="btn" id="saveView">Save view</button>
    </div>
    <div id="views" class="chips"></div>
  </section>
</main>

<!-- QR overlay -->
<div id="qrOverlay" class="qr-overlay no-print" style="display:none">
  <div class="qr-controls">
    <button class="btn" id="qrClose">Close</button>
    <button class="btn blue" onclick="window.print()">Print</button>
  </div>
  <div id="qrGrid" class="qr-grid"></div>
</div>

<script>
/* ---------- utilities & robust data load ---------- */
const PALETTE=["#10b981","#60a5fa","#f59e0b","#ef4444","#a78bfa","#34d399","#f472b6","#f97316","#22d3ee","#84cc16"];
const FALLBACK_LOC=["Jasper Primary Care","Jasper Pediatrics","Jasper MedSpa","Roswell Primary Care","Roswell MedSpa","Canton Primary Care","Canton Pediatrics","Canton MedSpa","Rome Primary Care","Rome MedSpa"];
async function getJSON(u){const r=await fetch(u,{cache:'no-store'});if(!r.ok)throw new Error(r.status);return r.json();}
async function loadData(){
  try{const d=await getJSON('/.netlify/functions/inventory'); return {items:Array.isArray(d)?d:(d.items||[]),source:'fn'};}
  catch(e){try{const d=await getJSON('/data.json');return{items:Array.isArray(d)?d:(d.items||[]),source:'fallback'};}
  catch(e2){return{items:[],source:'error'};}}
}
async function loadCfg(){try{return await getJSON('/.netlify/functions/config');}catch{return{locations:FALLBACK_LOC,categories:["Desktops","Laptops","Phones","Other"]};}}
function by(list, key){const m=new Map();list.forEach(x=>{const k=(typeof key==='function')?key(x):(x[key]||'Unknown');m.set(k,(m.get(k)||0)+1)});return m;}
function toCSV(rows){
  if(!rows.length) return '';
  const keys=[...new Set(rows.flatMap(r=>Object.keys(r)))];
  const esc=v=>`"${String(v??'').replaceAll('"','""')}"`;
  return [keys.join(','),...rows.map(r=>keys.map(k=>esc(r[k])).join(','))].join('\n');
}
function parseDate(s){ if(!s) return null; const d=new Date(s); return isNaN(d)?null:d; }
function daysUntil(d){ const ms=d - new Date(); return Math.ceil(ms/86400000);}

/* ---------- small helpers ---------- */
function pie(ctx,labels,data){const colors=labels.map((_,i)=>PALETTE[i%PALETTE.length]);return new Chart(ctx,{type:'pie',data:{labels,datasets:[{data,backgroundColor:colors,borderColor:'#fff',borderWidth:2}]},options:{plugins:{legend:{display:false}},maintainAspectRatio:false,responsive:true}});}
function bar(ctx,labels,data){return new Chart(ctx,{type:'bar',data:{labels,datasets:[{data,backgroundColor:'#60a5fa'}]},options:{plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}});}

/* ---------- main ---------- */
(async ()=>{
  const [{items,source}, cfg] = await Promise.all([loadData(), loadCfg()]);
  const health=document.getElementById('health');
  if(source==='fn'){ health.textContent='Live data'; health.className='badge fn-ok'; }
  else if(source==='fallback'){ health.textContent='Using data.json'; health.className='badge fn-fallback'; }
  else { health.textContent='Data error'; health.className='badge fn-error'; }

  const data = items;
  const cats = cfg.categories?.length?cfg.categories:[...new Set(data.map(x=>x.category).fi]()
