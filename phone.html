<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Phone Directory</title>
<link rel="stylesheet" href="style.css"/>
<style>
  .note{padding:.6rem .8rem;border:1px solid #e5e7eb;border-radius:10px;background:#f9fafb;color:#374151}
  .dim{color:#6b7280}
</style>
</head>
<body>
<header id="topbar" class="topbar">
  <div class="topbar-inner">
    <a class="btn" href="index.html">Home</a>
    <h1 style="margin:0;font-size:1.05rem">Phone Directory</h1>
  </div>
</header>

<main class="container">
  <section class="pill">
    <div class="row" style="gap:.5rem;flex-wrap:wrap;align-items:center">
      <input id="q" type="search" placeholder="Search name, extension, role, team, email, location…"/>
      <select id="loc"><option value="">All locations</option></select>
      <select id="team"><option value="">All teams</option></select>
      <select id="status"><option value="">Any status</option><option>Active</option><option>Deactivated</option></select>
    </div>
    <div id="statusMsg" class="note" style="display:none;margin-top:.5rem"></div>
  </section>

  <div id="grid" class="grid"></div>
</main>

<script>
/* ---------------- helpers ---------------- */
async function fetchJSON(url){
  const r = await fetch(url, {cache:'no-store'});
  if(!r.ok) throw new Error('HTTP '+r.status);
  return await r.json();
}
function setOptions(sel, arr, label){
  sel.innerHTML = label?`<option value="">${label}</option>`:'';
  [...new Set(arr.filter(Boolean))].sort()
    .forEach(v => sel.insertAdjacentHTML('beforeend', `<option>${v}</option>`));
}
function ucfirst(s){s=String(s||''); return s? s[0].toUpperCase()+s.slice(1): s;}
function normStatus(v){
  if (v===true || String(v).toLowerCase()==='true') return 'Active';
  const s = String(v||'').toLowerCase();
  if (s==='active') return 'Active';
  if (s==='inactive' || s==='deactivated' || s==='disabled') return 'Deactivated';
  return ucfirst(v||'');
}
function normalizeRow(p){
  // try many possible field names -> unified shape
  const name = p.name || p.full_name || p.displayName || p.user || '';
  const ext  = p.extension || p.ext || p.exten || p.ext_no || p.extention || '';
  const direct = p.direct || p.direct_line || p.directLine || '';
  const mobile = p.mobile || p.cell || p.phone || '';
  const email  = p.email || p.mail || '';
  const location = p.location || p.site || p.office || p.locationName || '';
  const role   = p.role || p.title || p.position || '';
  const status = normStatus(p.status ?? p.active);

  let team = p.team ?? p.teams ?? '';
  if (Array.isArray(team)) team = team.join(', ');
  // also support pipe/semicolon separated strings
  if (typeof team === 'string') team = team.replace(/[|;]+/g, ', ').replace(/\s*,\s*/g, ', ').trim();

  return { name, extension: String(ext||'').trim(), direct, mobile, email, location, team, role, status };
}
function card(p){
  const tags=[p.team,p.location,p.status].filter(Boolean).map(t=>`<span class="badge">${t}</span>`).join(' ');
  const call = p.extension?`<a class="btn sm" href="tel:${p.extension}">Call</a>`:'';
  const mail = p.email?`<a class="btn sm" href="mailto:${p.email}">Email</a>`:'';
  return `
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:.5rem">
      <h3>${p.name||'-'}</h3>
      <div>${tags}</div>
    </div>
    <div class="kv">
      <div class="marker">Extension</div><div>${p.extension||'-'}</div>
      <div class="marker">Direct</div><div>${p.direct||'-'}</div>
      <div class="marker">Mobile</div><div>${p.mobile||'-'}</div>
      <div class="marker">Email</div><div>${p.email||'-'}</div>
      <div class="marker">Location</div><div>${p.location||'-'}</div>
      <div class="marker">Role</div><div>${p.role||'-'}</div>
    </div>
    <div class="row" style="gap:.5rem;margin-top:.5rem">${call}${mail}</div>
  </div>`;
}
function getParam(k){ return new URLSearchParams(location.search).get(k)||''; }

/* -------------- robust loader -------------- */
async function loadPhones(){
  const candidates = [
    // your "quick" function likely lives at one of these
    '/.netlify/functions/phone_quick',
    '/.netlify/functions/phones_quick',
    '/.netlify/functions/phones',
    '/.netlify/functions/phone',
    // plain files
    '/phones.json',
    '/data/phones.json'
  ];
  const tried = [];
  for (const u of candidates){
    try{
      const j = await fetchJSON(u);
      let rows = [];
      if (Array.isArray(j)) rows = j;
      else if (Array.isArray(j.items)) rows = j.items;
      else if (Array.isArray(j.records)) rows = j.records;
      else if (Array.isArray(j.rows)) rows = j.rows;
      else if (Array.isArray(j.data)) rows = j.data;
      else tried.push(`${u} (shape not recognized)`);

      if (rows.length){
        return {
          items: rows.map(normalizeRow).filter(x=>x.name||x.extension||x.email),
          source: u
        };
      }
      tried.push(`${u} (empty)`);
    }catch(e){
      tried.push(`${u} (error)`);
    }
  }
  return {items:[], source:null, tried};
}

/* -------------- main -------------- */
(async()=>{
  const {items, source, tried=[]} = await loadPhones();

  const grid=document.getElementById('grid');
  const q=document.getElementById('q'), loc=document.getElementById('loc'),
        team=document.getElementById('team'), status=document.getElementById('status');
  const statusMsg=document.getElementById('statusMsg');

  if(!items.length){
    statusMsg.style.display='block';
    statusMsg.innerHTML = `<strong>No phone data found.</strong>
      <div class="dim" style="margin-top:.25rem">Tried: ${tried.join(' → ')}</div>`;
  }else{
    setOptions(loc, items.map(p=>p.location), 'All locations');
    setOptions(team, items.flatMap(p=>(p.team||'').split(',').map(s=>s.trim())), 'All teams');
    statusMsg.style.display='block';
    statusMsg.textContent = `Loaded ${items.length} entries from ${source}.`;
  }

  // preset search from ?q=
  const preset = (getParam('q')||'').trim();
  if(preset){ q.value=preset; }

  function run(){
    const text=(q.value||'').toLowerCase();
    const lsel=loc.value||'';
    const tsel=team.value||'';
    const ssel=status.value||'';
    let list = items;

    if(text){
      list = list.filter(p => (`${p.name} ${p.extension} ${p.email} ${p.location} ${p.team} ${p.role}`.toLowerCase().includes(text)));
    }
    if(lsel) list = list.filter(p => (p.location||'')===lsel);
    if(tsel) list = list.filter(p => (p.team||'').split(',').map(s=>s.trim()).includes(tsel));
    if(ssel) list = list.filter(p => String(p.status||'').toLowerC
