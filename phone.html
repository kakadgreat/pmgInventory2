<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Phone Directory</title>
<link rel="stylesheet" href="/style.css"/>
<style>
  .wrap{max-width:1180px;margin:0 auto;padding:24px}
  .toolbar{background:#f7f8fb;border:1px solid #eef0f4;border-radius:12px;padding:12px;display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  .toolbar input[type=search]{flex:1 1 280px}
  .select{appearance:none;border:1px solid #e6e9ef;border-radius:10px;padding:.55rem .9rem;background:#fff}
  .chips{display:flex;gap:8px;flex-wrap:wrap}
  .chip{border:1px solid #e6e9ef;background:#fff;border-radius:999px;padding:.35rem .7rem;font-size:.875rem;cursor:pointer}
  .chip.on{background:#eaffef;border-color:#2ecc71;color:#2a7f4f}
  .cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(310px,1fr));gap:14px;margin-top:14px}
  .card{background:#fff;border:1px solid #eef0f4;border-radius:12px;padding:14px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .pill{display:inline-block;border:1px solid #e6e9ef;border-radius:999px;padding:.15rem .55rem;font-size:.75rem;background:#fff;margin-right:6px}
  .status{border-radius:999px;padding:.15rem .5rem;font-size:.75rem;border:1px solid #e6e9ef;background:#fff}
  .status.Active{background:#eaffef;border-color:#2ecc71;color:#2a7f4f}
  .status.Deactivated,.status.Inactive{background:#ffecec;border-color:#ffb3b3;color:#b33434}
  .btn{border:1px solid #e6e9ef;background:#fff;border-radius:10px;padding:.45rem .75rem;cursor:pointer}
  .btn:hover{background:#f6f8fc}
  .meta{font-size:.87rem;color:#404553}
  .note{font-size:.8rem;color:#6b7280;margin-top:6px}
</style>
</head>
<body>
<div class="wrap">
  <h1 style="margin:0 0 10px">Phone Directory</h1>

  <div class="toolbar">
    <input id="q" type="search" placeholder="Search name, extension, role, email…"/>
    <select id="loc" class="select"><option value="">All locations</option></select>
    <select id="status" class="select"><option value="">Any status</option><option>Active</option><option>Inactive</option><option>Deactivated</option></select>
    <div id="teamChips" class="chips" aria-label="Team filters"></div>
  </div>

  <div id="debug" class="note" style="margin:8px 2px;"></div>
  <div id="results" class="cards" role="list"></div>
</div>

<script>
(async function(){
  const TEAM_CANON = ['PROVIDERS','FRONT OFFICE','BILLING','ADMINISTRATION','MA','PEDIATRICS','SPA','CALL CENTER','IT','LEADERSHIP'];

  const els={q:document.getElementById('q'),loc:document.getElementById('loc'),status:document.getElementById('status'),
             teamChips:document.getElementById('teamChips'),debug:document.getElementById('debug'),results:document.getElementById('results')};

  const params=new URLSearchParams(location.search);
  const forceDb = (params.get('source')||'').toLowerCase()==='db';

  async function fetchJSON(u){const r=await fetch(u,{cache:'no-store'});if(!r.ok)throw new Error(u+': '+r.status);return r.json();}

  // Prefer your DB function first (the one used by /phone_quick.html)
  const functionFirst = [
    '/.netlify/functions/phone_quick',
    '/.netlify/functions/phones',
    '/.netlify/functions/phone'
  ];
  const fileFallback = ['/phones.json','/data/phones.json'];

  const candidates = forceDb ? functionFirst : [...functionFirst, ...fileFallback];

  let raw=[], source=null, tried=[];
  for (const u of candidates){
    try{
      const j = await fetchJSON(u);
      const rows = Array.isArray(j) ? j :
                   Array.isArray(j.items) ? j.items :
                   Array.isArray(j.records) ? j.records :
                   Array.isArray(j.rows) ? j.rows :
                   Array.isArray(j.data) ? j.data : [];
      if(rows.length){ raw=rows; source=u; break; }
      tried.push(`${u} (empty)`);
    }catch(e){ tried.push(`${u} (error)`); }
  }

  if(!raw.length){
    els.debug.textContent = `No phone data found. Tried: ${tried.join(' → ')}`;
    return;
  }

  // Normalization
  const normStatus=v=>{
    const s=String(v??'').toLowerCase();
    if (v===true||s==='true'||s==='active') return 'Active';
    if (['inactive','deactivated','disabled','false'].includes(s)) return 'Deactivated';
    return (v||'').toString();
  };
  const canonTeamsFor=(raw)=>{
    const t=(raw||'').toUpperCase(); const out=new Set();
    TEAM_CANON.forEach(c=>{if(t.includes(c)) out.add(c);});
    if(t.includes('PEDIATRIC')) out.add('PEDIATRICS');
    if(t.includes('MESSAGE PRO')) out.add('CALL CENTER');
    if(t.includes('ADMIN')) out.add('ADMINISTRATION');
    if(t.includes(' MA')) out.add('MA');
    return [...out];
  };
  const data = raw.map(p=>{
    return {
      name: p.name||p.full_name||p.displayName||p.user||'',
      extension: String(p.extension||p.ext||p.exten||'').trim(),
      direct_phone: p.direct||p.direct_line||'',
      mobile: p.mobile||p.cell||'',
      email: p.email||'',
      location: p.location||p.site||'',
      role: p.role||p.title||'',
      status: normStatus(p.status ?? p.active),
      _teams: canonTeamsFor(p.team||p.teams||'')
    };
  });

  els.debug.textContent = `Loaded ${data.length} entries from ${source}`;

  // build locations
  [...new Set(data.map(d=>d.location).filter(Boolean))].sort()
    .forEach(l=>{const o=document.createElement('option');o.value=o.textContent=l;els.loc.appendChild(o);});

  // team chips
  const selected=new Set();
  TEAM_CANON.forEach(t=>{
    const btn=document.createElement('button'); btn.type='button'; btn.className='chip'; btn.textContent=t;
    btn.onclick=()=>{ if(selected.has(t)){selected.delete(t);btn.classList.remove('on');} else {selected.add(t);btn.classList.add('on');} render(); };
    els.teamChips.appendChild(btn);
  });

  function match(r){
    const text=(els.q.value||'').toLowerCase(), loc=els.loc.value, st=els.status.value;
    if(text && !(`${r.name} ${r.extension} ${r.email} ${r.location} ${r.role}`.toLowerCase().includes(text))) return false;
    if(loc && r.location!==loc) return false;
    if(st && (r.status||'').toLowerCase()!==st.toLowerCase()) return false;
    if(selected.size && ![...selected].every(t=>r._teams.includes(t))) return false;
    return true;
  }

  function statusBadge(s){const cls=(''+s).replace(/\s+/g,''); return `<span class="status ${cls}">${s||'-'}</span>`;}
  function card(r){
    const teams = r._teams.map(t=>`<span class="pill">${t}</span>`).join(' ');
    return `<div class="card" role="listitem">
      <div style="display:flex;justify-content:space-between;gap:8px;align-items:center;">
        <div class="meta"><strong>${r.name||'-'}</strong></div>${statusBadge(r.status)}
      </div>
      <div class="note" style="margin:6px 0 8px">${teams||''}</div>
      <div class="row">
        <div>
          <div class="meta"><b>Extension</b><br>${r.extension||'-'}</div>
          <div class="meta"><b>Direct</b><br>${r.direct_phone||'-'}</div>
          <div class="meta"><b>Mobile</b><br>${r.mobile||'-'}</div>
        </div>
        <div>
          <div class="meta"><b>Email</b><br>${r.email||'-'}</div>
          <div class="meta"><b>Location</b><br>${r.location||'-'}</div>
          <div class="meta"><b>Role</b><br>${r.role||'-'}</div>
        </div>
      </div>
      <div style="display:flex;gap:8px;margin-top:8px">
        ${r.extension?`<a class="btn" href="tel:${r.extension}">Call</a>`:''}
        ${r.email?`<a class="btn" href="mailto:${r.email}">Email</a>`:''}
      </div>
    </div>`;
  }

  function render(){ els.results.innerHTML = data.filter(match).map(card).join('') || `<div class="note">No results.</div>`; }
  ['input','change'].forEach(ev=>{els.q.addEventListener(ev,render);els.loc.addEventListener(ev,render);els.status.addEventListener(ev,render);});
  render();
})();
</script>
</body>
</html>
