<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Phone Directory</title>
<link rel="stylesheet" href="style.css"/>
</head>
<body>
<header id="topbar" class="topbar">
  <div class="topbar-inner">
    <h1 style="margin:0;font-size:1.1rem">Phone Directory</h1>
  </div>
</header>

<main class="container">
  <section class="pill">
    <div class="row" style="gap:.5rem;flex-wrap:wrap;align-items:center">
      <input id="q" type="search" placeholder="Search name, extension, role, team, email, locationâ€¦" />
      <select id="loc"><option value="">All locations</option></select>
      <select id="team"><option value="">All teams</option></select>
      <select id="status"><option value="">Any status</option><option>Active</option><option>Deactivated</option></select>
    </div>
  </section>

  <div id="grid" class="grid"></div>
</main>

<script>
async function getJSON(u){const r=await fetch(u,{cache:'no-store'}); if(!r.ok) throw new Error(r.status); return r.json();}
async function load(){ try{ const d=await getJSON('/.netlify/functions/phones'); return Array.isArray(d)?d:(d.items||[]); } catch{ try{ const d=await getJSON('/phones.json'); return Array.isArray(d)?d:(d.items||[]);} catch{ return []; } } }
function set(sel,arr,label){ sel.innerHTML = label?`<option value="">${label}</option>`:''; [...new Set(arr.filter(Boolean))].sort().forEach(v=>sel.insertAdjacentHTML('beforeend',`<option>${v}</option>`)); }
function card(p){
  const tags=[p.team,p.location,p.status].filter(Boolean).map(t=>`<span class="badge">${t}</span>`).join(' ');
  const actions = p.email?`<a class="btn sm" href="mailto:${p.email}">Email</a>`:'';
  const call = p.extension?`<a class="btn sm" href="tel:${p.extension}">Call</a>`:'';
  return `<div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:.5rem">
      <h3>${p.name||'-'}</h3><span>${tags}</span>
    </div>
    <div class="kv">
      <div class="marker">Extension</div><div>${p.extension||'-'}</div>
      <div class="marker">Direct</div><div>${p.direct||'-'}</div>
      <div class="marker">Mobile</div><div>${p.mobile||'-'}</div>
      <div class="marker">Email</div><div>${p.email||'-'}</div>
      <div class="marker">Location</div><div>${p.location||'-'}</div>
      <div class="marker">Role</div><div>${p.role||'-'}</div>
    </div>
    <div class="row" style="gap:.5rem;margin-top:.5rem">${call}${actions}</div>
  </div>`;
}
function getParam(k){ return new URLSearchParams(location.search).get(k)||''; }

(async()=>{
  const people = await load();
  const q=document.getElementById('q'), loc=document.getElementById('loc'), team=document.getElementById('team'), status=document.getElementById('status'), grid=document.getElementById('grid');

  set(loc, people.map(p=>p.location), 'All locations');
  set(team, people.flatMap(p=>(p.team||'').split(',').map(s=>s.trim())), 'All teams');

  const preset = (getParam('q')||'').trim();
  if(preset){ q.value=preset; }

  function run(){
    const text=(q.value||'').toLowerCase();
    const lsel=loc.value||'';
    const tsel=team.value||'';
    const ssel=status.value||'';
    let list = people;

    if(text){
      list = list.filter(p => (`${p.name} ${p.extension} ${p.email} ${p.location} ${p.team} ${p.role}`.toLowerCase().includes(text)));
    }
    if(lsel) list=list.filter(p=>(p.location||'')===lsel);
    if(tsel) list=list.filter(p=>(p.team||'').split(',').map(s=>s.trim()).includes(tsel));
    if(ssel) list=list.filter(p=>String(p.status||'').toLowerCase()===ssel.toLowerCase());

    grid.innerHTML = list.map(card).join('') || `<div class="small" style="padding:.5rem 0">No results.</div>`;
  }
  [q,loc,team,status].forEach(el=>el.addEventListener('input',run));
  run();
})();
</script>
</body>
</html>
