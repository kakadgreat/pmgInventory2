<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Inventory Table</title>
  <link rel="stylesheet" href="style.css"/>

  <!-- Page-local styles: print layout + blue buttons -->
  <style>
    .actions-right{ display:flex; gap:.5rem; align-items:center; }
    .btn.blue{ background:#e0f2fe; border:1px solid #bae6fd; color:#075985; }
    .btn.blue:hover{ filter:brightness(.98); }

    th.sortable{ cursor:pointer; user-select:none; }
    th .arrow{ opacity:.45; margin-left:.25rem; }
    th.sort-active{ background:#ecfdf5; color:#065f46; border-bottom-color:#10b981 !important; }
    th.sort-active .arrow{ opacity:1; }

    .chips{ display:flex; gap:.5rem; flex-wrap:wrap; margin:.35rem 0; }
    .chip{ border:1px solid #e5e7eb; background:#fff; padding:.35rem .65rem; border-radius:999px; cursor:pointer; }
    .chip.active{ background:#ecfdf5; border-color:#10b981; color:#065f46; }

    .note{ padding:.5rem .75rem; border:1px solid #e5e7eb; border-radius:8px; background:#f9fafb; }
    .small{ font-size:.9rem; color:#6b7280; }

    /* ---------- Print polishing ---------- */
    @page{ size: Letter; margin: 0.5in; }
    .print-only{ display:none; }
    @media print{
      /* Hide chrome we don't want on paper */
      .topbar, .actions-right, .chips, .filters, .btn, .note, #status { display:none !important; }

      /* Show a nice print header */
      .print-only{ display:block !important; }

      /* Remove padding/borders from cards and container */
      .container{ width:auto; margin:0; }
      .pill{ background:transparent; border:none; padding:0; box-shadow:none; }

      /* Make table full-width, bordered, readable */
      .table-wrap{ border:none; box-shadow:none; overflow:visible !important; }
      table{ width:100% !important; border-collapse:collapse !important; table-layout:fixed; }
      thead{ display:table-header-group; } /* repeat on each page */
      th, td{ border:1px solid #d1d5db !important; padding:6pt 8pt !important; font-size:10pt !important; vertical-align:top; }
      th{ background:#f3f4f6 !important; color:#111827 !important; }

      /* Avoid weird page breaks inside rows */
      tr{ break-inside:avoid; page-break-inside:avoid; }
    }
  </style>
</head>
<body>
  <header id="topbar" class="topbar">
    <div class="topbar-inner">
      <a class="btn" href="index.html">Home</a>
      <a class="btn" href="list.html">List</a>
      <a class="btn" href="table.html">Table</a>
      <a class="btn" href="locations.html">Locations</a>
    </div>
  </header>

  <main class="container screenfill">
    <!-- Visible only on print -->
    <section class="print-only" style="margin-bottom:.5rem">
      <h1 style="font-size:14pt; margin:0 0 4pt 0;">Inventory Overview</h1>
      <div id="printMeta" style="font-size:9pt; color:#374151;"></div>
    </section>

    <!-- Controls + overview chips -->
    <section class="pill">
      <h2 style="margin:0 0 .25rem 0">Inventory Overview</h2>

      <!-- Category chips with counts (multi-select) -->
      <div id="catChips" class="chips"></div>

      <!-- Filters left, actions right -->
      <div class="row" style="justify-content:space-between; gap:.5rem; flex-wrap:wrap; align-items:center">
        <div class="filters row" style="gap:.5rem; flex-wrap:wrap">
          <input id="q" type="search" placeholder="Search title, serial, brand, location…" />
          <select id="loc"><option value="">All locations</option></select>
          <select id="w">
            <option value="">Any warranty</option>
            <option>Active</option>
            <option>Deactivated</option>
          </select>
        </div>

        <div class="actions-right">
          <a class="btn blue" href="admin/add">+ Add</a>
          <button class="btn blue" onclick="window.print()">Print</button>
        </div>
      </div>

      <div id="status" class="note small" style="display:none"></div>
    </section>

    <!-- Data table -->
    <section class="table-wrap">
      <table class="table" id="t">
        <thead id="th">
          <tr>
            <th class="sortable" data-k="category">Category <span class="arrow">↕</span></th>
            <th class="sortable" data-k="brand">Brand <span class="arrow">↕</span></th>
            <th class="sortable" data-k="title">Title <span class="arrow">↕</span></th>
            <th class="sortable" data-k="serial">Serial <span class="arrow">↕</span></th>
            <th class="sortable" data-k="location">Location <span class="arrow">↕</span></th>
            <th class="sortable" data-k="room">Room <span class="arrow">↕</span></th>
            <th class="sortable" data-k="dept">Dept <span class="arrow">↕</span></th>
            <th class="sortable" data-k="warranty_status">Warranty status <span class="arrow">↕</span></th>
            <th class="sortable" data-k="warranty_expires">Warranty expires <span class="arrow">↕</span></th>
            <th class="col-actions">Actions</th>
          </tr>
        </thead>
        <tbody id="tb"></tbody>
      </table>
    </section>
  </main>

  <script>
    // ---------- Robust data loading with fallback ----------
    async function fetchJSON(url){
      const res = await fetch(url, {cache:'no-store'});
      if(!res.ok) throw new Error(`HTTP ${res.status}`);
      return await res.json();
    }
    async function loadData(){
      try{
        return await fetchJSON('/.netlify/functions/inventory');
      }catch{
        try{ return await fetchJSON('/data.json'); }
        catch{ throw new Error('Could not load inventory from function or data.json'); }
      }
    }
    async function loadConfig(){
      try{ return await fetchJSON('/.netlify/functions/config'); }
      catch{ return { locations: [], categories: [] }; }
    }

    function setSelect(sel, arr, label){
      sel.innerHTML = label?`<option value="">${label}</option>`:'';
      [...new Set((arr||[]).filter(Boolean))].sort()
        .forEach(v => sel.insertAdjacentHTML('beforeend', `<option>${v}</option>`));
    }
    function groupBy(xs,k){
      return (xs||[]).reduce((a,x)=>((a[x[k]||'']=(a[x[k]||'']||[]).concat(x)),a),{});
    }

    // ---------- Page state ----------
    let data = [];
    let sortK = 'title';
    let sortDir = 'asc';
    const activeCats = new Set();

    function cmp(a,b,k){
      const av=(a[k]??'').toString().toLowerCase();
      const bv=(b[k]??'').toString().toLowerCase();
      if(av<bv) return -1; if(av>bv) return 1; return 0;
    }
    function sortList(list){
      const s=[...list].sort((a,b)=>cmp(a,b,sortK));
      return sortDir==='asc'?s:s.reverse();
    }

    function drawTable(list){
      const tb = document.getElementById('tb');
      tb.innerHTML = (list||[]).map(x=>`
        <tr>
          <td>${x.category||'-'}</td>
          <td>${x.brand||'-'}</td>
          <td><a class="row-link" href="admin/edit.html?slug=${encodeURIComponent(x.slug||'')}">${x.title||'-'}</a></td>
          <td>${x.serial||'-'}</td>
          <td>${x.location||'-'}</td>
          <td>${x.room||'-'}</td>
          <td>${x.dept||'-'}</td>
          <td>${x.warranty_status||'-'}</td>
          <td>${x.warranty_expires||'-'}</td>
          <td class="col-actions"><a class="btn sm" href="admin/edit.html?slug=${encodeURIComponent(x.slug||'')}">Edit</a></td>
        </tr>
      `).join('') || `<tr><td colspan="10" class="small">No results.</td></tr>`;

      document.querySelectorAll('th.sortable').forEach(th=>{
        th.classList.toggle('sort-active', th.dataset.k===sortK);
        const arrow = th.querySelector('.arrow');
        if(arrow) arrow.textContent = th.dataset.k===sortK ? (sortDir==='asc'?'▲':'▼') : '↕';
      });
    }

    function warrantyNorm(s){
      s=String(s||'').trim().toLowerCase();
      if(s==='active'||s==='deactivated') return s[0].toUpperCase()+s.slice(1);
      return 'Unknown';
    }

    (async ()=>{
      const status = document.getElementById('status');
      try{
        const [d, c] = await Promise.all([loadData(), loadConfig()]);
        data = Array.isArray(d)? d : (d.items||[]);

        if(!data.length){
          status.style.display='block';
          status.textContent = 'No inventory items were returned. If you just added data, refresh once more.';
        }

        // Build print header meta (totals)
        const byCat = groupBy(data,'category');
        const byW   = groupBy(data, x => warrantyNorm(x.warranty_status));
        const totals = [
          `Total: ${data.length}`,
          ...Object.keys(byCat).filter(Boolean).sort().map(k=>`${k}: ${(byCat[k]||[]).length}`),
          ...Object.keys(byW).filter(Boolean).sort().map(k=>`${k}: ${(byW[k]||[]).length}`)
        ].join(' • ');
        const now = new Date();
        document.getElementById('printMeta').textContent =
          `${now.toLocaleDateString()} ${now.toLocaleTimeString()} — ${totals}`;

        // Category chips (use configured order if present)
        const order = (c.categories && c.categories.length) ? c.categories : Object.keys(byCat);
        const chipsHost = document.getElementById('catChips');
        chipsHost.innerHTML = (order||[]).filter(Boolean)
          .map(cat => `<span class="chip" data-cat="${cat}">${cat} (${(byCat[cat]||[]).length||0})</span>`)
          .join('') || `<span class="small">No categories found.</span>`;

        chipsHost.addEventListener('click', (e)=>{
          const t=e.target.closest('[data-cat]'); if(!t) return;
          const name=t.dataset.cat;
          if(activeCats.has(name)) activeCats.delete(name); else activeCats.add(name);
          chipsHost.querySelectorAll('[data-cat]').forEach(el=>{
            el.classList.toggle('active', activeCats.has(el.dataset.cat));
          });
          run();
        });

        // Filters
        const q  = document.getElementById('q');
        const loc= document.getElementById('loc');
        const w  = document.getElementById('w');

        const locs = (c.locations && c.locations.length) ? c.locations : data.map(x=>x.location);
        setSelect(loc, locs, 'All locations');

        function run(){
          const text=(q.value||'').toLowerCase();
          const lsel=loc.value||'';
          const wsel=w.value||'';

          let list=data;
          if(activeCats.size) list=list.filter(x=>activeCats.has(x.category||''));
          if(lsel) list=list.filter(x=>(x.location||'')===lsel);
          if(wsel) list=list.filter(x=>String(x.warranty_status||'').toLowerCase()===wsel.toLowerCase());
          if(text){
            list=list.filter(x=>(`${x.title} ${x.brand} ${x.model} ${x.serial} ${x.asset_tag} ${x.location} ${x.room} ${x.dept}`.toLowerCase().includes(text)));
          }
          drawTable(sortList(list));
        }
        [q,loc,w].forEach(el=>el.addEventListener('input',run));
        run();

        // Sorting
        document.querySelectorAll('th.sortable').forEach(th=>{
          th.addEventListener('click', ()=>{
            const k=th.dataset.k;
            if(k===sortK){ sortDir = (sortDir==='asc'?'desc':'asc'); }
            else { sortK=k; sortDir='asc'; }
            run();
          });
        });

      }catch(err){
        console.error(err);
        status.style.display='block';
        status.textContent = 'Error: could not load inventory (tried function and data.json). Check your Netlify Function logs or ensure data.json exists.';
      }
    })();
  </script>
</body>
</html>
