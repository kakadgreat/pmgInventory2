<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Add Inventory Item</title>
<link rel="stylesheet" href="../style.css"/>
</head>
<body>
<header id="topbar" class="topbar">
  <div class="topbar-inner">
    <a class="btn" href="../index.html">← Home</a>
    <a class="btn" href="../list.html">List</a>
    <a class="btn" href="../table.html">Table</a>
    <strong style="margin-left:.5rem">Add Item</strong>
  </div>
</header>

<main class="container screenfill">
  <form id="f" class="zones">
    <!-- Identity -->
    <section class="zone half">
      <h2>Identity & Classification</h2>
      <div class="grid2">
        <label>Category
          <select name="category" id="category" required></select>
        </label>
        <label>Brand <input name="brand" required></label>
        <label>Title <input name="title" placeholder="e.g., Dell OptiPlex 7000" required></label>
        <label>Model <input name="model"></label>
        <label>Asset tag <input name="asset_tag"></label>
        <label>Serial <input name="serial"></label>
        <label>Status <input name="status" placeholder="In use / Spare / Repair"></label>
      </div>
    </section>

    <!-- Ownership / Location -->
    <section class="zone half">
      <h2>Ownership & Location</h2>
      <div class="grid2">
        <label>User <input name="user"></label>
        <label>Email <input name="email" type="email"></label>
        <label>Location
          <select name="location" id="location"></select>
        </label>
        <label>Room <input name="room" placeholder="Front Desk / 102A"></label>
        <label>Dept <input name="dept" placeholder="Front Desk / Billing / IT"></label>
        <span></span>
      </div>
    </section>

    <!-- Hardware -->
    <section class="zone half">
      <h2>Hardware Specs</h2>
      <div class="grid2">
        <label>OS <input name="os" placeholder="Windows 11 / macOS"></label>
        <label>CPU <input name="cpu" placeholder="i5-12400 / M2"></label>
        <label>RAM <input name="ram" placeholder="16 GB"></label>
        <label>Storage <input name="storage" placeholder="512 GB SSD"></label>
      </div>
    </section>

    <!-- Lifecycle / Warranty -->
    <section class="zone half">
      <h2>Lifecycle & Warranty</h2>
      <div class="grid2">
        <label>Warranty status
          <select name="warranty_status" id="wstatus">
            <option>Active</option>
            <option>Deactivated</option>
          </select>
        </label>
        <label>Warranty expires <input name="warranty_expires" placeholder="YYYY-MM-DD"></label>
        <label>Purchase date <input name="purchase_date" placeholder="YYYY-MM-DD"></label>
        <span></span>
      </div>
    </section>

    <!-- Notes -->
    <section class="zone">
      <h2>Notes</h2>
      <textarea name="notes" rows="3" placeholder="Any special instructions or history"></textarea>
    </section>

    <section class="sticky-actions">
      <div class="row" style="justify-content:flex-end">
        <a class="btn" href="../list.html">Cancel</a>
        <button class="btn primary" type="submit">Save Item</button>
      </div>
      <div id="msg" class="small" style="margin-top:.25rem"></div>
    </section>
  </form>
</main>

<script>
const FALLBACK_LOCATIONS=["Jasper Primary Care","Jasper Pediatrics","Jasper MedSpa","Roswell Primary Care","Roswell MedSpa","Canton Primary Care","Canton Pediatrics","Canton MedSpa","Rome Primary Care","Rome MedSpa"];
async function cfg(){ try{ const r=await fetch('/.netlify/functions/config'); if(r.ok) return await r.json(); }catch{} return { categories:["Desktops","Laptops","Phones","Printers","Scanners","Other"], locations:FALLBACK_LOCATIONS }; }
function fill(sel,items){ sel.innerHTML=''; items.forEach(v=>sel.insertAdjacentHTML('beforeend',`<option>${v}</option>`)); }

(async () => {
  const c = await cfg();
  fill(document.getElementById('category'), (c.categories||[]).length?c.categories:["Desktops","Laptops","Phones","Other"]);
  fill(document.getElementById('location'), (c.locations||[]).length?c.locations:FALLBACK_LOCATIONS);
})();

const f=document.getElementById('f'), msg=document.getElementById('msg');
f.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const o=Object.fromEntries(new FormData(f).entries());
  Object.keys(o).forEach(k=>{ if(o[k]==='') delete o[k]; });
  // generate slug from title + serial/asset
  const base = (o.title||'').toLowerCase().replace(/[^\w]+/g,'-');
  const tail = (o.serial||o.asset_tag||'').toLowerCase().replace(/[^\w]+/g,'-');
  o.slug = `${base}-${tail}`.replace(/(^-|-$)/g,'') || `item-${Date.now()}`;
  const res = await fetch('/.netlify/functions/inventory', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ item:o }) });
  msg.textContent = res.ok ? 'Saved ✔  Redirecting…' : 'Error saving item';
  if(res.ok) setTimeout(()=>location.href='../edit.html?slug='+encodeURIComponent(o.slug), 600);
});
</script>
</body>
</html>
