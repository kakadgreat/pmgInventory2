<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Edit Item</title>
<link rel="stylesheet" href="../style.css"/>
</head>
<body>
<header class="topbar"><div class="topbar-inner">
  <a class="btn" href="../list.html">‚Üê Back to List</a>
  <strong style="margin-left:.5rem">Edit Item</strong>
</div></header>

<main class="container">
  <section class="pill">
    <form id="f" style="display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:8px">
      <input name="slug" id="slug" type="hidden">
      <label>Category
        <select name="category" id="category" required></select>
      </label>
      <label>Title <input name="title" id="title"></label>

      <label>Brand <input name="brand" id="brand"></label>
      <label>Model <input name="model" id="model"></label>

      <label>Asset tag <input name="asset_tag" id="asset_tag"></label>
      <label>Serial <input name="serial" id="serial"></label>

      <label>User <input name="user" id="user"></label>
      <label>Email <input name="email" id="email"></label>

      <label>Location
        <select name="location" id="location"></select>
      </label>
      <label>Room <input name="room" id="room"></label>

      <label>Dept <input name="dept" id="dept"></label>
      <label>Status <input name="status" id="status"></label>

      <label>Warranty status
        <select name="warranty_status" id="warranty_status">
          <option value="">(none)</option>
          <option>Active</option>
          <option>Deactivated</option>
        </select>
      </label>
      <label>Warranty expires <input name="warranty_expires" id="warranty_expires" placeholder="YYYY-MM-DD"></label>

      <label>OS <input name="os" id="os"></label>
      <label>CPU <input name="cpu" id="cpu"></label>

      <label>RAM <input name="ram" id="ram"></label>
      <label>Storage <input name="storage" id="storage"></label>

      <label style="grid-column:1/-1">Notes <input name="notes" id="notes"></label>

      <button class="btn primary" type="submit" style="grid-column:1/-1">Save</button>
    </form>
    <pre id="out" class="small" style="margin-top:8px"></pre>
  </section>
</main>

<script>
async function loadCfg(){
  try { const r = await fetch('/.netlify/functions/config'); if (r.ok) return await r.json(); } catch {}
  return (await (await fetch('../assets/config.json')).json());
}
async function loadItem(slug){
  const r = await fetch('/.netlify/functions/inventory?slug='+encodeURIComponent(slug));
  const arr = await r.json(); return arr[0] || {};
}
function fillSelect(sel, items){
  sel.innerHTML = ''; (items||[]).forEach(v => sel.insertAdjacentHTML('beforeend', `<option>${v}</option>`));
}
(async () => {
  const params = new URLSearchParams(location.search);
  const slug = params.get('slug');
  if(!slug){ alert('Missing slug'); history.back(); return; }

  const cfg = await loadCfg();
  fillSelect(document.getElementById('category'), cfg.categories || []);
  fillSelect(document.getElementById('location'), cfg.locations || []);

  const x = await loadItem(slug);
  const f = document.getElementById('f');
  Object.keys(x).forEach(k => { const el = document.getElementById(k); if(el) el.value = x[k] || ''; });
  document.getElementById('slug').value = slug;

  f.addEventListener('submit', async (e) => {
    e.preventDefault();
    const o = Object.fromEntries(new FormData(f).entries());
    Object.keys(o).forEach(k => { if(o[k]==='') delete o[k]; });
    o.slug = slug; // keep same ID
    const res = await fetch('/.netlify/functions/inventory', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ item:o })});
    const txt = await res.text(); document.getElementById('out').textContent = txt;
  });
})();
</script>
</body>
</html>
