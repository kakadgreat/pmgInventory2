<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Manage Phone Directory</title>
<link rel="stylesheet" href="../style.css"/>
</head>
<body>
<header class="topbar"><div class="topbar-inner">
  <a class="btn" href="../phone.html">View Directory</a>
  <strong style="margin-left:.5rem">Manage Directory</strong>
</div></header>

<main class="container">
  <section class="pill">
    <div class="row" style="justify-content:space-between;gap:.5rem;flex-wrap:wrap">
      <div class="row">
        <input id="q" type="search" placeholder="Search name / ext / email" />
        <select id="loc"><option value="">All locations</option></select>
        <select id="team"><option value="">All teams</option></select>
        <select id="stat"><option value="">Any status</option><option>Active</option><option>Inactive</option></select>
      </div>
      <div class="row">
        <a class="btn" href="phone_add.html">+ Add</a>
        <a class="btn" href="phone_upload.html">Bulk upload</a>
        <button class="btn" id="dedupe">üßπ Dedupe</button>
        <button class="btn" id="wipe" style="border-color:#ef4444;color:#991b1b">üóëÔ∏è Delete ALL</button>
      </div>
    </div>
  </section>

  <section class="pill">
    <div id="table"></div>
  </section>
</main>

<script>
async function loadCfg(){ try{ const r=await fetch('/.netlify/functions/config'); if(r.ok) return await r.json(); }catch{} return {locations:[],teams:[]}; }
async function loadDir(){ const r=await fetch('/.netlify/functions/directory',{cache:'no-store'}); return r.ok?await r.json():[]; }
function setOpts(sel, arr, label){ sel.innerHTML=label?`<option value="">${label}</option>`:''; [...new Set(arr.filter(Boolean))].sort().forEach(v=>sel.insertAdjacentHTML('beforeend', `<option>${v}</option>`)); }

function rowHtml(x, cfg){
  const teams = (cfg.teams||[]).map(t=>`<option ${((x.team||'').toLowerCase().includes(t.toLowerCase()))?'selected':''}>${t}</option>`).join('');
  const locs  = (cfg.locations||[]).map(t=>`<option ${((x.location||'')===t)?'selected':''}>${t}</option>`).join('');
  return `
  <div style="border:1px solid var(--line); border-radius:12px; padding:.6rem; margin:.5rem 0">
    <div class="row" style="justify-content:space-between">
      <div><b>${x.name||'-'}</b> ‚Ä¢ <span class="small">Ext ${x.extension||'-'}</span> ‚Ä¢ <span class="small">${x.location||'-'}</span></div>
      <div class="row">
        <button class="btn" data-edit="${x.slug}">Edit</button>
        <button class="btn" data-del="${x.slug}">Delete</button>
      </div>
    </div>
    <form class="edit" id="form-${x.slug}" style="display:none; margin-top:.5rem; grid-template-columns:repeat(2,minmax(0,1fr)); gap:.5rem">
      <input type="hidden" name="slug" value="${x.slug}">
      <label>Name <input name="name" value="${x.name||''}"></label>
      <label>Extension <input name="extension" value="${x.extension||''}"></label>
      <label>Email <input name="email" value="${x.email||''}"></label>
      <label>Role <input name="role" value="${x.role||''}"></label>
      <label>Team <select name="team"><option value="">(none)</option>${teams}</select></label>
      <label>Status <select name="status"><option ${x.status==='Active'?'selected':''}>Active</option><option ${x.status==='Inactive'?'selected':''}>Inactive</option></select></label>
      <label>Location <select name="location"><option value="">(none)</option>${locs}</select></label>
      <label>Direct <input name="direct_phone" value="${x.direct_phone||''}"></label>
      <label>Mobile <input name="mobile" value="${x.mobile||''}"></label>
      <label>Timezone <input name="timezone" value="${x.timezone||''}"></label>
      <label>Device vendor <input name="device_vendor" value="${x.device_vendor||''}"></label>
      <label>Device model <input name="device_model" value="${x.device_model||''}"></label>
      <label>MAC <input name="mac" value="${x.mac||''}"></label>
      <label>IP <input name="ip" value="${x.ip||''}"></label>
      <label style="grid-column:1/-1">Notes <input name="notes" value="${x.notes||''}"></label>
      <button class="btn primary" type="submit" style="grid-column:1/-1">Save</button>
    </form>
  </div>`;
}

(async () => {
  const cfg = await loadCfg();
  let data = await loadDir();

  const q=document.getElementById('q'), locSel=document.getElementById('loc'), teamSel=document.getElementById('team'), statSel=document.getElementById('stat');
  setOpts(locSel, cfg.locations.length?cfg.locations:data.map(x=>x.location), 'All locations');
  setOpts(teamSel, cfg.teams.length?cfg.teams:[], 'All teams');

  const render = () => {
    const text=(q.value||'').toLowerCase(), loc=locSel.value||'', team=teamSel.value||'', stat=statSel.value||'';
    let list = data;
    if (loc)  list = list.filter(x => (x.location||'') === loc);
    if (team) list = list.filter(x => (x.team||'').toLowerCase().split(',').map(s=>s.trim()).includes(team.toLowerCase()));
    if (stat) list = list.filter(x => (x.status||'').toLowerCase() === stat.toLowerCase());
    if (text) list = list.filter(x => (`${x.name} ${x.extension} ${x.email} ${x.direct_phone}`.toLowerCase().includes(text)));
    const html = list.map(x => rowHtml(x, cfg)).join('');
    const mount = document.getElementById('table');
    mount.innerHTML = html || '<div class="small">No results.</div>';

    mount.querySelectorAll('[data-edit]').forEach(btn => {
      btn.onclick = () => {
        const id = 'form-' + btn.dataset.edit;
        const f = document.getElementById(id);
        f.style.display = (f.style.display==='none'||!f.style.display) ? 'grid' : 'none';
      };
    });
    mount.querySelectorAll('form.edit').forEach(f => {
      f.onsubmit = async (e) => {
        e.preventDefault();
        const o = Object.fromEntries(new FormData(f).entries());
        Object.keys(o).forEach(k=>{ if(o[k]==='') delete o[k]; });
        await fetch('/.netlify/functions/directory', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ item:o }) });
        data = await loadDir(); render();
      };
    });
    mount.querySelectorAll('[data-del]').forEach(btn => {
      btn.onclick = async () => {
        if (!confirm('Delete this entry?')) return;
        await fetch('/.netlify/functions/directory?slug='+encodeURIComponent(btn.dataset.del), { method:'DELETE' });
        data = await loadDir(); render();
      };
    });
  };

  [q,locSel,teamSel,statSel].forEach(el=>el.addEventListener('input', render));
  locSel.addEventListener('change', render); teamSel.addEventListener('change', render); statSel.addEventListener('change', render);
  render();

  // buttons
  document.getElementById('dedupe').onclick = async () => {
    if (!confirm('Remove older duplicates (keep newest per person/extension)?')) return;
    const r = await fetch('/.netlify/functions/directory?action=dedupe', { method:'DELETE' });
    const j = await r.json(); alert(j.ok ? `Removed ${j.removed} duplicate(s).` : 'Error'); data = await loadDir(); render();
  };
  document.getElementById('wipe').onclick = async () => {
    if (!confirm('DELETE ALL records? This cannot be undone.')) return;
    const r = await fetch('/.netlify/functions/directory?action=wipe', { method:'DELETE' });
    const j = await r.json(); alert(j.ok ? 'All rows deleted.' : 'Error'); data = await loadDir(); render();
  };
})();
</script>
</body>
</html>
